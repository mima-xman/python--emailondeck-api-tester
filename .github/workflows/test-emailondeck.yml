name: Test EmailOnDeck API

on:
  workflow_dispatch:
    inputs:
      use_tor:
        description: 'Use Tor for requests'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      max_retries:
        description: 'Maximum number of retries'
        required: false
        default: '3'
        type: string
      timeout:
        description: 'Timeout for waiting for email (seconds)'
        required: false
        default: '60'
        type: string
      max_loops:
        description: 'Maximum number of signup loops'
        required: false
        default: 20
        type: number

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        instance: [1, 2, 3, 4, 5, 6]
      fail-fast: false
    name: Test Instance ${{ matrix.instance }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
      
      - name: Install Tor
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y tor

      - name: Configure Tor
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          # Ensure ControlPort is enabled (standard 9051) and CookieAuth disabled
          echo "ControlPort 9051" | sudo tee -a /etc/tor/torrc
          echo "CookieAuthentication 0" | sudo tee -a /etc/tor/torrc

      - name: Start Tor Service
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          # Restart Tor service
          sudo systemctl restart tor@default
          sudo systemctl status tor@default --no-pager
          
          # Wait for Tor to be ready
          sleep 10
          
          echo "Tor ports listening:"
          sudo ss -tulpn | grep tor

      - name: Detect and Set Tor Ports
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          TOR_SOCKS_PORT=$(sudo ss -tulpn | grep tor | grep LISTEN | grep -v ":9051" | awk '{print $5}' | awk -F: '{print $NF}' | head -n 1)
          TOR_CONTROL_PORT=$(sudo ss -tulpn | grep tor | grep LISTEN | grep ":9051" | awk '{print $5}' | awk -F: '{print $NF}' | head -n 1)

          if [ -z "$TOR_SOCKS_PORT" ]; then
            echo "WARNING: Could not detect Socks Port. Defaulting to 9050."
            TOR_SOCKS_PORT=9050
          fi

          if [ -z "$TOR_CONTROL_PORT" ]; then
            echo "WARNING: Could not detect Control Port. Defaulting to 9051."
            TOR_CONTROL_PORT=9051
          fi

          echo "TOR_PORT=$TOR_SOCKS_PORT" >> $GITHUB_ENV
          echo "TOR_CONTROL_PORT=$TOR_CONTROL_PORT" >> $GITHUB_ENV

      - name: Show Tor Environment
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          echo "TOR_PORT=$TOR_PORT"
          echo "TOR_CONTROL_PORT=$TOR_CONTROL_PORT"

      - name: Test Tor SOCKS Connectivity
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          echo "Testing raw SOCKS connection to Tor..."
          curl --socks5 127.0.0.1:${TOR_PORT} https://check.torproject.org/api/ip --max-time 20 -v

      # - name: Verify Tor Exit IP
      #   if: ${{ github.event.inputs.use_tor == 'true' }}
      #   run: |
      #     echo "Tor exit IP:"
      #     curl --socks5 127.0.0.1:${TOR_PORT} https://api.ipify.org --max-time 20
      #     echo

      # - name: Test Tor HTTPS (known-good site)
      #   if: ${{ github.event.inputs.use_tor == 'true' }}
      #   run: |
      #     echo "Testing Tor HTTPS to example.com"
      #     curl --socks5 127.0.0.1:${TOR_PORT} https://example.com --max-time 20 -I -v

      # - name: Test EmailOnDeck via Tor (expected to fail)
      #   if: ${{ github.event.inputs.use_tor == 'true' }}
      #   run: |
      #     echo "Testing EmailOnDeck via Tor (expect timeout)"
      #     curl --socks5 127.0.0.1:${TOR_PORT} https://www.emailondeck.com --max-time 20 -v || true

      # - name: Test EmailOnDeck WITHOUT Tor
      #   if: ${{ github.event.inputs.use_tor == 'false' }}
      #   run: |
      #     echo "Testing EmailOnDeck without Tor"
      #     curl https://www.emailondeck.com --max-time 20 -I -v
      
      - name: Warmup Tor Connection
        if: ${{ github.event.inputs.use_tor == 'true' }}
        run: |
          echo "Warming up Tor connection..."
          # Try to connect to a reliable endpoint to ensure the circuit is built
          for i in {1..5}; do
            if curl --socks5 127.0.0.1:${TOR_PORT} https://check.torproject.org/api/ip --max-time 10 -s; then
              echo "Tor connection established!"
              exit 0
            fi
            echo "Waiting for Tor ($i/5)..."
            sleep 5
          done
          echo "WARNING: Tor warmup failed, proceeding anyway but errors are likely."
      
      - name: Run EmailOnDeck Test
        run: |
          python InstagramGen.py
        env:
          USE_TOR: ${{ github.event.inputs.use_tor }}
          MAX_RETRIES: ${{ github.event.inputs.max_retries }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
          MAX_LOOPS: ${{ github.event.inputs.max_loops }}
          PYTHONUNBUFFERED: "1"
      
      - name: Test Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Test Execution Completed"
          echo "=========================================="
          echo "Check the logs above for results"

      - name: Upload Accounts Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: instagram-accounts-${{ matrix.instance }}
          path: instagram_accounts.json
          retention-days: 5
      
      - name: Upload Debug Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots-${{ matrix.instance }}
          path: |
            *.png
            *.html
          retention-days: 1